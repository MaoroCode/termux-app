name: Build Termux AAR and DEX

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Modules
        run: ./gradlew :terminal-view:assembleRelease :terminal-emulator:assembleRelease

      - name: Extract and Convert to DEX
        run: |
          mkdir -p output/terminal-view/dex_temp output/terminal-emulator/dex_temp
          
          D8_PATH=$(find $ANDROID_HOME/build-tools -name d8 | sort -V | tail -n 1)
          
          cp terminal-view/build/outputs/aar/*-release.aar output/terminal-view/view.aar
          unzip output/terminal-view/view.aar classes.jar -d output/terminal-view/
          $D8_PATH output/terminal-view/classes.jar --output output/terminal-view/dex_temp/
          mv output/terminal-view/dex_temp/classes.dex output/terminal-view/classes.dex

          cp terminal-emulator/build/outputs/aar/*-release.aar output/terminal-emulator/emulator.aar
          unzip output/terminal-emulator/emulator.aar classes.jar -d output/terminal-emulator/
          $D8_PATH output/terminal-emulator/classes.jar --output output/terminal-emulator/dex_temp/
          mv output/terminal-emulator/dex_temp/classes.dex output/terminal-emulator/classes.dex

          rm -rf output/terminal-view/dex_temp output/terminal-emulator/dex_temp
          rm output/terminal-view/classes.jar output/terminal-emulator/classes.jar

      - name: Upload Termux Assets
        uses: actions/upload-artifact@v4
        with:
          name: Termux-Project-Files-Main
          path: output/
